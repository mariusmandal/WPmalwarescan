<?php

function malware_c_stats() {
	global $wpdb;
	
	$green = "SELECT COUNT(`id`) AS `count` FROM `wpms2012_malware_status` WHERE `flag` = 'green';";
	$red = "SELECT COUNT(`id`) AS `count` FROM `wpms2012_malware_status` WHERE `flag` = 'red';";
	$blue = "SELECT COUNT(`id`) AS `count` FROM `wpms2012_malware_status` WHERE `flag` = 'blue';";
	$all = "SELECT COUNT(`id`) AS `count` FROM `wpms2012_malware_status`;";
	
	$green = $wpdb->get_row( $green, ARRAY_A );
	$red = $wpdb->get_row( $red, ARRAY_A );
	$blue = $wpdb->get_row( $blue, ARRAY_A );
	$all = $wpdb->get_row( $all, ARRAY_A );

		
	$time = "SELECT `scan_start`,`scan_stop` FROM `wpms2012_malware_scan` "
		.   "ORDER BY `scan_id` DESC "
		.   "LIMIT 1";
	$time = $wpdb->get_row( $time, ARRAY_A );
	
	return array('last_scan'=>__('Started').' ' 
								. date('d.m.Y H:i', $time['scan_start'])
								. ($time['scan_stop']=='0' 
									? ' ' . __('and is still running') .' '
									: ' ' . __('and lasted for') .' '
									  . malware_timeAgo($time['scan_start'],$time['scan_stop'])
									),
				 'flag_green'=>$green['count'],
				 'flag_blue'=>$blue['count'],
				 'flag_red'=>$red['count'],
				 'files_scanned'=>$all['count']);

}

function malware_filelog($file) {
	$sql = "SELECT * FROM `wpms2012_malware_status`
			WHERE `path` = '".$file."';";
	global $wpdb;
	$sql = $wpdb->get_row( $sql, ARRAY_A );
	if($row['flag']=='green'||empty($row['flag']))
		$info['text'] = '';
	else
		$info['text'] = '<br /><span class="malware_explain_file">'
					.    '<span class="normal" title="eval">eval: '.$row['eval'].'</span> '
					.    '<span class="normal" title="base64_decode">base64_decode: '.$row['base64_decode'].'</span> '
					.    '<span class="normal" title="edoced_46esab">edoced_46esab: '.$row['edoced_46esab'].'</span> '
					.    '<span class="normal" title="strrev">strrev: '.$row['strrev'].'</span> '
					.    '<span class="normal" title="preg_">preg_: '.$row['preg_'].'</span> '
					.    '<span class="normal" title="preg_">fread: '.$row['fread'].'</span> '
					.    '<span class="normal" title="preg_">curl: '.$row['curl'].'</span> '
					.   '</span>'
					;
	$info['flag'] = $row['flag'];
	$ico = (empty($info['flag'])
			? 'bullet-green'
			: 'flag-'.$info['flag']);
	$info['ico'] = plugins_url('ico/'.$ico.'.png', __FILE__);
	return $info;
}

function malware_getDir($path, $level = 0 ){
	$directories = $files = array();
	
	#$root = str_replace('/public_html','',$_SERVER['DOCUMENT_ROOT']);
	$root = $_SERVER['DOCUMENT_ROOT'];
	if(strpos($path,$root)===false)
		$path = $root.'/'. $path;
	
	if(substr($path, strlen($path)-1)=='/')
		$path = substr($path,0,strlen($path)-1);
	
	if($path!==$root){
		$folders = explode('/',$path);
		array_pop($folders);
		$directories[] = '<a href="javascript:loadBrowser(\''.implode('/',$folders).'\');">..</a>';
	}
	// Open the directory to the handle $dh
	$dh = @opendir( $path );
    // Loop through the directory
	while( false !== ( $file = readdir( $dh ) ) ){
		if(in_array($file,array('.','..')))	continue;
		if( is_dir( "$path/$file" ) )
			$directories[] = '<a href="javascript:loadBrowser(\''.$path.'/'.$file.'\');">'.$file.'</a>';
		else {
			$extension = pathinfo($file, PATHINFO_EXTENSION);
			$files[] = malware_browser_filestatus($path.'/'.$file);
		}
	}
    // Close the directory handle
	closedir( $dh );
	if(is_array($directories))
		sort($directories);
	if(is_array($files))
		sort($files);
	return array('dirs'=>implode('<br />',$directories), 'files'=>implode('<br />',$files));
}

function malware_timeAgo($from, $to) {
	$s = (int)$from - (int)$to;
	if($s<0)
		$s = $s*-1;
    $m=0;
    $hr=0;
    $d=0;
    $td="now";
    
    if($s>59) {
        $m = (int)($s/60);
        $s = $s-($m*60); // sec left over
        $td = "$m minute"; if($m>1) $td .= 's';
    }
    if($m>59){
        $hr = (int)($m/60);
        $m = $m-($hr*60); // min left over
        $td = "$hr hour"; if($hr>1) $td .= "s";
#        if($m>0) $td .= ", $m min";
    }
    if($hr>23){
        $d = (int)($hr/24);
        $hr = $hr-($d*24); // hr left over
        $td = "$d day"; if($d>1) $td .= "s";
    }
    
    return $td;
}
?>