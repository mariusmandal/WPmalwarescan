<?php
error_reporting(E_ALL);
require_once('../../../wp-config.php');

if(!isset($_SERVER['DOCUMENT_ROOT'])) {
	$_SERVER['DOCUMENT_ROOT'] = $_SERVER['HOME'].'/public_html';
}
echo $_SERVER['DOCUMENT_ROOT'];

$db = mysql_connect(DB_HOST, DB_USER, DB_PASSWORD);
mysql_select_db(DB_NAME, $db);
$start = "INSERT INTO `wpms2012_malware_scan` "
		."(`scan_id` ,`scan_start` ,`scan_stop`)"
		." VALUES "
		."('' , '".time()."', '');";
$start = mysql_query($start);
$id = mysql_insert_id($db);
$counter_red_flags = 0;
$filer = array();
$ignoreExt = explode(',','jpg,swf,pdf,psd,tif,png,jpeg,gif,mov,mp3,mp4,mpeg4,doc,xls,ppt,zip,gzip,tar,gz');
#getDirectory(str_replace('/public_html','',$_SERVER['DOCUMENT_ROOT']));

getDirectory($_SERVER['DOCUMENT_ROOT']);

function getDirectory($path){
	global $ignoreExt;
	// Open the directory to the handle $dh
	$dh = @opendir( $path );
	// Loop through the directory
	while( false !== ( $file = readdir( $dh ) ) ){
		if(in_array($file, array('error_log','.','..')))	continue;
		if( is_dir( "$path/$file" ) ){
			// Its a directory, so we need to keep reading down...
			getDirectory( "$path/$file");    
		} else {    
            $extension = pathinfo($file, PATHINFO_EXTENSION);
			if(in_array(strtolower($extension),$ignoreExt))
				continue;
			#echo scanForCode("$path/$file");
			scanForCode("$path/$file");
		}
	}
    // Close the directory handle
    closedir( $dh );
}


function doScan($file,$updated) {
	$sql = "SELECT * FROM `wpms2012_malware_status`
			WHERE `path` = '".$file."';";
	$res = mysql_query($sql);
	if(!$res)
		return true;

	$row = mysql_fetch_assoc($res);
	if($row['modified']!==$updated)
		return true;
	return false;
}

function scanForCode($file) {
	$updated = filemtime($file);
	if(!doScan($file,$updated))
		return $file .'<br />';
	
	$lines = file($file);
	$data = implode('\r\n', $lines);
	
	$eval = substr_count($data, 'eval');
	$base64_decode = substr_count($data, 'base64_decode');
	$edoced_46esab = substr_count($data, 'edoced_46esab');
	$strrev = substr_count($data, 'strrev');
	$preg_ = substr_count($data, 'preg_');
	$fread = substr_count($data, 'fread');
	$curl = substr_count($data, 'curl');
	
	if($eval==0 && $base64_decode==0 && $edoced_46esab==0 && $strrev==0 && $preg_==0)
		$flag = 'green';
	else
		$flag = flag($file, $eval, $base64_decode, $edoced_46esab, $strrev, $preg_, $fread, $curl);
	
	$sql = "DELETE FROM `wpms2012_malware_status` WHERE `path` = '".$file."';";
	mysql_query($sql);
	
	$sql = "INSERT INTO `wpms2012_malware_status` "
		.  "(`id` ,`path` ,`eval` ,`base64_decode` ,`edoced_46esab` ,`strrev` ,`preg_` ,`modified`, `flag`, `fread`, `curl`)"
		.  " VALUES "
		.  "('' , '$file', '$eval', '$base64_decode', '$edoced_46esab', '$strrev', '$preg_', '$updated', '$flag', '$fread', '$curl');";
	mysql_query($sql);
	return $file . ': <img src="ico/flag-'.$flag.'.png" width="10" /><br />';

}

function flag($file, $eval, $base64_decode, $edoced_46esab, $strrev, $preg_, $fread, $curl){
	global $counter_red_flags, $filer;
	$sql = "SELECT * FROM `wpms2012_malware_status`
			WHERE `path` = '".$file."';";
	$res = mysql_query($sql) or die(mysql_error());
	if(!$res)									return 'red';
	$row = mysql_fetch_assoc($res);
	
/*
	if($row['flag']=='blue') {
		var_dump($row);
		var_dump($eval);
		var_dump($base64_decode);
		var_dump($edoced_46esab);
		var_dump($strrev);
		var_dump($preg_);		
	}
*/
	$filer[] = $file;
	$counter_red_flags++;	
	if($row['flag']=='red')							return 'red';
	if((int)$row['eval']!==$eval)					return 'red';
	if((int)$row['base64_decode']!==$base64_decode)	return 'red';
	if((int)$row['edoced_46esab']!==$edoced_46esab)	return 'red';
	if((int)$row['strrev']!==$strrev)				return 'red';
	if((int)$row['preg_']!==$preg_)					return 'red';
	if((int)$row['fread']!==$fread)					return 'red';
	if((int)$row['curl']!==$curl)					return 'red';
	$counter_red_flags--;
	array_pop($filer);
	return 'blue';
}

if($counter_red_flags > 0) {
	mail('support@ukm.no', 'Mulig malware', 'I et scan fant serveren '.$counter_red_flags.' mulig infiserte filer! ('.implode("\r\n",$filer).')');
}
$stop = "UPDATE `wpms2012_malware_scan` "
		."SET `scan_stop` = '".time()."' "
		."WHERE `scan_id` = '".$id."';";
$stop = mysql_query($stop);
?>