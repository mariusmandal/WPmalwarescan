<?php
/* 
Plugin Name: MalwareScan
Plugin URI: http://www.ukm-norge.no
Description: MalwareScan loops all files and folders of server, looking for suspicious files. All potential threats stored in database, and is to be checked regularily. 
Author: UKM Norge / M Mandal 
Version: 1.1 
Author URI: http://mariusmandal.no
*/


add_filter('UKMWPNETWDASH_messages', 'WPmalwarescan_dashmessages', -100);

function WPmalwarescan_dashmessages( $MESSAGES ) {
	global $wpdb;
	$red = $wpdb->get_row("SELECT COUNT(`id`) AS `count` FROM `wpms2012_malware_status` WHERE `flag` = 'red';", ARRAY_A );

	if( $red['count'] > 0)
		$MESSAGES[] = array('level' 	=> 'alert-danger',
							'module'	=> 'Malwarescanner',
							'header'	=> 'Det er funnet '. $red['count'] .' mulig infiserte filer på serveren!',
							'body' 		=> 'Undersøk problemet umiddelbart',
							'link'		=> '?page=MalwareScanner'
							);
	return $MESSAGES;
}




require_once 'hooks.php';

function malware_menu() {
	$page = add_menu_page(__('MalwareScan'), __('MalwareScan'), 'administrator', 'MalwareScanner', 'MalwareScanner', plugins_url('ico/trojan-menu.png',__FILE__),510);
	
	add_action( 'admin_print_styles-' . $page, 'malware_admin_scripts_and_styles' );

}

function MalwareScanner() {
	global $wpdb;
	require_once 'controller.php';
	require_once 'view.php';
}

function malware_admin_scripts_and_styles() {
       wp_enqueue_style('malwareCSS', plugins_url('malware.css', __FILE__) );
       wp_enqueue_script('malwareJS', plugins_url('malware.js', __FILE__) );
}

function malware_ajax_browser() {
	global $wpdb;
	require_once 'controller.php';
	$VIEW = 'file_browser';
	require_once 'view.php';
	die();
}

function malware_ajax_red() {
	global $wpdb;
	require_once 'controller.php';
	$VIEW = 'report_red';
	require_once 'view.php';
	die();
}

function malware_fix_below_threshold() {
	global $wpdb;
	$sql = $wpdb->query("UPDATE `wpms2012_malware_status`
						 SET `flag` = 'blue'
						 WHERE `flag` = 'red'
						 AND (`eval`+`base64_decode`+`edoced_46esab`+`strrev`+`preg_`+`fread`+`curl`) <= 2");
	echo 'Fixed '. $sql .' files';
	die();
}

function malware_fix_preg() {
	global $wpdb;
	$sql = $wpdb->query("UPDATE `wpms2012_malware_status`
						 SET `flag` = 'blue'
						 WHERE `flag` = 'red'
						 AND `eval` = '0'
						 AND `base64_decode` = '0'
						 AND `edoced_46esab` = '0'
						 AND `strrev` = '0'
						 AND `preg_` > '0'");
 	echo 'Fixed '. $sql .' files';
	die();
}

function malware_approve_file() {
	global $wpdb;
	$sql = $wpdb->query("UPDATE `wpms2012_malware_status`
						 SET `flag` = 'blue'
						 WHERE `path` = '".$_POST['path']."'
						 LIMIT 1");
	echo 'Approved';
	die();
}

function malware_file_compare_contents(){
	echo '<div style="border: 2px solid #ccc; padding: 2px;background: #ddd;">'
		. '<div style="float:right;"><a href="javascript:malware_goback();">'.__('Cancel, go back').'</a></div>'

		. '<strong>File: </strong>'
		. $_POST['file']
		. ' <img src="'.plugins_url('ico/flag-red.png',__FILE__).'" '
		.  'style="border: 0px none;" width="10" />'

		. '<br />'

		. '<strong>Change flag to: </strong>'
		. '<a href="javascript:approveFile(\''.$_POST['file'].'\');">'
		.  '<img src="'.plugins_url('ico/flag-blue.png',__FILE__).'" '
		.   'style="border: 0px none;" width="15" />'
		. '</a>'

		.'</div>';
	$lines = file($_POST['file']);
	$data = implode("\r\n", $lines);
	echo nl2br(htmlentities($data));
	
	echo '<br /><br />'
		.'<a href="#top">'.__('To the top').'</a>'
		.'<br /><br />';
	die();
}

?>