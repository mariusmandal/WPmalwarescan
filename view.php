<?php
if(!isset($VIEW))
	$VIEW == 'default';


switch($VIEW) {
	case 'report_red':
		malware_red_content();
		break;

	case 'file_browser':
		malware_browser_content();
		break;

	default:
		echo '<div class="wrap">'
			. '<img src="'.plugin_dir_url(__FILE__).'ico/trojan-32.png" border="0" '
			.  'style="float:left; margin-right: 6px; margin-top: 6px;" />'
			. '<h2>'.__('Malware scanner').'</h2>'
			. '<p class="lead">Malwarescanneren markerer alle filer som har endret seg siden sist scan, '
			. 'og som inneholder kjente funksjonsnavn brukt i hacking. '
			. 'Ved oppdagelse flagges filene r&oslash;dt, og m&aring; leses gjennom av noen som '
			. 'skj&oslash;nner hvordan kildekoden b&oslash;r se ut, og hvordan hackede filer vanligvis'
			. ' ser ut.</p>'
			;
		malware_filecompare();
		malware_dash();
		echo '</div>';
		break;
}



function malware_filecompare() {
	echo '<div id="malware_file_compare" style="display:none;">'
		. '<div id="malware_file_compare_contents"></div>'
		.'</div>';
}

function malware_dash() {
	$scanStats = malware_c_stats();
	echo '<div id="malware_dash_content">'	

		.'<div style="float: left; width: 450px; margin-right: 50px;">'
	
			.'<div id="malware_lastscan">'
			. '<strong>'.__('Last scan').':</strong> '
			. $scanStats['last_scan']
			.'</div>'
		
		 	.'<div id="malware_all">'
			. '<strong>'.__('Files scanned').':</strong> '
			. $scanStats['files_scanned']
			.'</div>'
		
			. '<div id="malware_red">'
			. '<strong>'.__('Files flagged red').':</strong> '
			. $scanStats['flag_red']
			. '<span class="malware_explain_flag">'. __('Files containing different number of threat since last scan').'</span>'
			.'</div>'
		
			. '<div id="malware_blue">'
			. '<strong>'.__('Files flagged blue').':</strong> '
			. $scanStats['flag_blue']
			. '<span class="malware_explain_flag">'. __('Files containing the same threat functions as last scan').'</span>'
			.'</div>'
		
			.'<div id="malware_green">'
			. '<strong>'.__('Files flagged green').':</strong> '
			. $scanStats['flag_green']
			. '<span class="malware_explain_flag">'. __('Not containing any threat-functions') .'</span>'
			.'</div>'
		.'</div>'

		.'<div style="margin-left: 20px; margin-top: -12px;" id="malware_tools">'
			.  '<img src="'.plugins_url('ico/tools.png', __FILE__).'" '
			.    'style="margin-top: -5px; margin-right: 10px; float:left;" width="20" border="0" />'
			. '<h3>'. __('Tools') .'</h3>'

			. '<a href="javascript:approveBelowThreshold()" id="malware_tool_threshold">'
			  .__('Approve files below threshold')
			. '</a>'

			. '<br />'
			
			. '<a href="javascript:approveOnlyPreg()" id="malware_tool_preg">'
			  .__('Approve files with only &quot;preg_&quot;-flags')
			. '</a>'

		.'</div>'

		. '<br clear="all" />'
		
		.'<div style="float: left; width: 450px; margin-right: 50px;" id="malware_report_browser">'
		. malware_browser()
		.'</div>'		
		
		.'<div style="margin-left: 20px;" id="malware_report_red">'
		. malware_red_report()
		.'</div>'
	
		.'</div>';
}

function malware_red_content() {
	global $wpdb;
	$qry = $wpdb->get_results("SELECT * 
							   FROM `wpms2012_malware_status`
							   WHERE `flag` = 'red'
							   ORDER BY `path` ASC
							   LIMIT 25",'ARRAY_A');
	foreach($qry as $i => $r) {
		echo malware_browser_filestatus($r['path']).'<br />';
	}
	echo '';
}

function malware_red_report() {
	return '<h3>'. __('Please check these files flagged red!') .'</h3>'
			.  'List will show 15 last files. <a href="javascript:loadReport();">Reload?</a>'
			.  '<div id="malware_report_red_container"></div>'
			;
}

function malware_browser() {
	return '<h3>'. __('Browse files on server') .'</h3>'
		.  '<div id="malware_browser" style="display: block;"></div>'
		;
}

function malware_browser_content(){
	$fnf = malware_getDir($_POST['path']);
	
	echo $fnf['dirs']
		.'<br />'
		.$fnf['files'];
}

function malware_browser_filestatus($file) {
	$info = malware_filelog($file);
	return '<a href="javascript:compareFileManually(\''.$file.'\');" class="compareFileManually" rel="'.$file.'">'
		.   '<img src="'.$info['ico'].'" width="10" border="0" /> '
		.   str_replace($_SERVER['DOCUMENT_ROOT'],'',$file)
		.  '</a>'
		.  ($info['flag']!='green' ? $info['text'] : '');
}
?>